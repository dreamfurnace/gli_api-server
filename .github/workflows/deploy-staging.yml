name: Deploy Django API to Staging

on:
  push:
    branches: [stg]
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: gli-api-staging
  ECS_CLUSTER: staging-gli-cluster
  ECS_SERVICE: staging-django-api-service
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest

    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: AWS ìê²© ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: AWS Secrets Managerì—ì„œ DB ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      id: get-db-secret
      run: |
        SECRET_JSON=$(aws secretsmanager get-secret-value \
          --secret-id gli/db/staging \
          --query SecretString \
          --output text)

        echo "DB_HOST=$(echo $SECRET_JSON | jq -r .host)" >> $GITHUB_ENV
        echo "DB_NAME=$(echo $SECRET_JSON | jq -r .dbname)" >> $GITHUB_ENV
        echo "DB_USER=$(echo $SECRET_JSON | jq -r .username)" >> $GITHUB_ENV
        echo "DB_PASSWORD=$(echo $SECRET_JSON | jq -r .password)" >> $GITHUB_ENV
        echo "DB_PORT=$(echo $SECRET_JSON | jq -r .port)" >> $GITHUB_ENV

        echo "âœ… DB ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

    - name: Generate .env.staging file
      run: |
        # í•œêµ­ ì‹œê°„ ê¸°ì¤€ BUILD_UID ìƒì„± (MM.DD-HH:MM:SS)
        export TZ='Asia/Seoul'
        BUILD_UID=$(date '+%m.%d-%H:%M:%S')
        echo "BUILD_UID=$BUILD_UID" >> $GITHUB_ENV
        echo "ğŸ¯ Generated BUILD_UID: $BUILD_UID (KST)"

        # .env.staging íŒŒì¼ ìƒì„±
        touch .env.staging
        echo "# GLI Django API - Staging Environment" >> .env.staging
        echo "# Generated by GitHub Actions at $BUILD_UID" >> .env.staging
        echo "" >> .env.staging

        # í™˜ê²½ ì„¤ì •
        echo "DJANGO_ENV=staging" >> .env.staging
        echo "BUILD_UID=$BUILD_UID" >> .env.staging
        echo "" >> .env.staging

        # ë³´ì•ˆ í‚¤
        echo "DJANGO_SECRET_KEY=${{ secrets.SECRET_KEY_STAGING }}" >> .env.staging
        echo "" >> .env.staging

        # ë°ì´í„°ë² ì´ìŠ¤ (Secrets Managerì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´)
        echo "DATABASE_NAME=${{ env.DB_NAME }}" >> .env.staging
        echo "DATABASE_USER=${{ env.DB_USER }}" >> .env.staging
        echo "DATABASE_PASSWORD=${{ env.DB_PASSWORD }}" >> .env.staging
        echo "DATABASE_HOST=${{ env.DB_HOST }}" >> .env.staging
        echo "DATABASE_PORT=${{ env.DB_PORT }}" >> .env.staging
        echo "" >> .env.staging

        # CORS ë° Allowed Hosts
        echo "CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS_STAGING }}" >> .env.staging
        echo "FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL_STAGING }}" >> .env.staging
        echo "DJANGO_ALLOWED_HOSTS=stg-api.glibiz.com,*.ap-northeast-2.elb.amazonaws.com,10.0.0.0/16" >> .env.staging
        echo "" >> .env.staging

        # AWS ì„¤ì •
        echo "AWS_REGION=ap-northeast-2" >> .env.staging
        echo "AWS_DEFAULT_REGION=ap-northeast-2" >> .env.staging
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env.staging
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env.staging
        echo "AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME_STAGING }}" >> .env.staging
        echo "AWS_S3_REGION=ap-northeast-2" >> .env.staging
        echo "" >> .env.staging

        # ê¸°íƒ€ ì„¤ì •
        echo "TIME_ZONE=Asia/Seoul" >> .env.staging
        echo "USE_TZ=True" >> .env.staging
        echo "LANGUAGE_CODE=ko-kr" >> .env.staging
        echo "PYTHONUNBUFFERED=1" >> .env.staging

        echo "ğŸ“ .env.staging íŒŒì¼ ìƒì„± ì™„ë£Œ ($(wc -l < .env.staging)ì¤„)"
        echo "ğŸ”‘ ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ ê°œìˆ˜: $(grep -c '=' .env.staging)"

    - name: JWT í‚¤ ì„¤ì •
      run: |
        mkdir -p keys
        echo "${{ secrets.JWT_PRIVATE_KEY_STAGING }}" > keys/jwt-private.pem &
        echo "${{ secrets.JWT_PUBLIC_KEY_STAGING }}" > keys/jwt-public.pem &
        wait
        echo "âœ… JWT í‚¤ ì„¤ì • ì™„ë£Œ"

    - name: ECR ë¡œê·¸ì¸
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘..."
        docker buildx create --use --name gli-builder || docker buildx use gli-builder
        docker buildx build \
          --platform linux/amd64 \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          --push \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:staging-latest \
          .
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"

    - name: Task Definition ìƒì„± ë° ë“±ë¡
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "ğŸ“ Task Definition ìƒì„± ì¤‘..."

        # VPC ì„¤ì • ì¡°íšŒ
        VPC_ID=$(aws ec2 describe-vpcs \
          --filters "Name=is-default,Values=true" \
          --query 'Vpcs[0].VpcId' \
          --output text)

        echo "VPC_ID=$VPC_ID" >> $GITHUB_ENV

        # Task Definition JSON ìƒì„±
        cat > task-definition.json <<EOF
        {
          "family": "staging-gli-django-api",
          "networkMode": "awsvpc",
          "requiresCompatibilities": ["FARGATE"],
          "cpu": "512",
          "memory": "1024",
          "executionRoleArn": "arn:aws:iam::917891822317:role/ecsTaskExecutionRole",
          "taskRoleArn": "arn:aws:iam::917891822317:role/ecsTaskExecutionRole",
          "containerDefinitions": [
            {
              "name": "django-api",
              "image": "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG",
              "essential": true,
              "portMappings": [
                {
                  "containerPort": 8000,
                  "protocol": "tcp"
                }
              ],
              "environment": [
                {
                  "name": "DJANGO_ENV",
                  "value": "staging"
                },
                {
                  "name": "BUILD_UID",
                  "value": "${{ env.BUILD_UID }}"
                },
                {
                  "name": "PYTHONUNBUFFERED",
                  "value": "1"
                }
              ],
              "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                  "awslogs-group": "/ecs/staging-gli-django-api",
                  "awslogs-region": "ap-northeast-2",
                  "awslogs-stream-prefix": "django-api",
                  "awslogs-create-group": "true"
                }
              },
              "healthCheck": {
                "command": ["CMD-SHELL", "curl -f http://localhost:8000/health/ || exit 1"],
                "interval": 30,
                "timeout": 5,
                "retries": 3,
                "startPeriod": 60
              }
            }
          ]
        }
        EOF

        # Task Definition ë“±ë¡
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
          --cli-input-json file://task-definition.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)

        echo "TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV
        echo "âœ… Task Definition ë“±ë¡ ì™„ë£Œ: $NEW_TASK_DEF_ARN"

    - name: Django ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
      run: |
        echo "ğŸ”„ Django ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘..."

        # ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì¡°íšŒ
        SUBNETS=$(aws ec2 describe-subnets \
          --filters "Name=vpc-id,Values=${{ env.VPC_ID }}" "Name=availability-zone,Values=ap-northeast-2a,ap-northeast-2b" \
          --query 'Subnets[0:2].SubnetId' \
          --output text | tr '\t' ',')

        # Security Group ì¡°íšŒ ë˜ëŠ” ìƒì„±
        SG_ID=$(aws ec2 describe-security-groups \
          --filters "Name=group-name,Values=staging-ecs-sg" \
          --query 'SecurityGroups[0].GroupId' \
          --output text 2>/dev/null || echo "")

        if [ -z "$SG_ID" ] || [ "$SG_ID" = "None" ]; then
          echo "âš ï¸  Security Groupì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ Security Groupì„ ìƒì„±í•˜ì„¸ìš”:"
          echo "aws ec2 create-security-group --group-name staging-ecs-sg --description 'ECS Staging Security Group' --vpc-id ${{ env.VPC_ID }}"
          exit 1
        fi

        echo "ë„¤íŠ¸ì›Œí¬ ì„¤ì •: Subnets=$SUBNETS, SecurityGroup=$SG_ID"

        # ë§ˆì´ê·¸ë ˆì´ì…˜ íƒœìŠ¤í¬ ì‹¤í–‰
        MIGRATION_TASK=$(aws ecs run-task \
          --cluster $ECS_CLUSTER \
          --task-definition ${{ env.TASK_DEF_ARN }} \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SG_ID],assignPublicIp=ENABLED}" \
          --overrides '{
            "containerOverrides": [{
              "name": "django-api",
              "command": ["sh", "-c", "uv run python manage.py migrate --verbosity=2 --noinput || (echo 'Migration failed, checking schema...' && uv run python manage.py showmigrations && exit 1)"],
              "environment": [
                {"name": "DJANGO_LOG_LEVEL", "value": "DEBUG"},
                {"name": "PYTHONUNBUFFERED", "value": "1"}
              ]
            }]
          }' \
          --query 'tasks[0].taskArn' \
          --output text)

        echo "ë§ˆì´ê·¸ë ˆì´ì…˜ íƒœìŠ¤í¬ ì‹¤í–‰: $MIGRATION_TASK"

        # ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ 8ë¶„)
        echo "â³ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        START_TIME=$(date +%s)
        TIMEOUT=480

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))

          if [ $ELAPSED -gt $TIMEOUT ]; then
            echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ íƒ€ì„ì•„ì›ƒ (8ë¶„ ì´ˆê³¼)"
            exit 1
          fi

          TASK_STATUS=$(aws ecs describe-tasks \
            --cluster $ECS_CLUSTER \
            --tasks $MIGRATION_TASK \
            --query 'tasks[0].lastStatus' \
            --output text)

          echo "ğŸ“Š ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ: $TASK_STATUS (ê²½ê³¼: ${ELAPSED}s)"

          if [ "$TASK_STATUS" = "STOPPED" ]; then
            echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ íƒœìŠ¤í¬ ì™„ë£Œ"
            break
          fi

          sleep 20
        done

        # ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ í™•ì¸
        MIGRATION_EXIT_CODE=$(aws ecs describe-tasks \
          --cluster $ECS_CLUSTER \
          --tasks $MIGRATION_TASK \
          --query 'tasks[0].containers[0].exitCode' \
          --output text)

        if [ "$MIGRATION_EXIT_CODE" != "0" ]; then
          echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: $MIGRATION_EXIT_CODE)"
          exit 1
        else
          echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ!"
        fi

    - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸš€ ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì‹œì‘..."

        # ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        SERVICE_EXISTS=$(aws ecs describe-services \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE \
          --query 'services[0].serviceName' \
          --output text 2>/dev/null || echo "")

        if [ -z "$SERVICE_EXISTS" ] || [ "$SERVICE_EXISTS" = "None" ]; then
          echo "âš ï¸  ECS ì„œë¹„ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "ì„œë¹„ìŠ¤ë¥¼ ë¨¼ì € ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
          exit 1
        fi

        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --task-definition ${{ env.TASK_DEF_ARN }} \
          --force-new-deployment

        echo "âœ… ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: ë°°í¬ ê²€ì¦
      run: |
        echo "ğŸ” ë°°í¬ ê²€ì¦ ì‹œì‘..."

        for i in {1..60}; do
          DEPLOYMENT_STATUS=$(aws ecs describe-services \
            --cluster "$ECS_CLUSTER" \
            --services "$ECS_SERVICE" \
            --query "services[0].deployments[?status=='PRIMARY'].rolloutState" \
            --output text)

          if [ "$DEPLOYMENT_STATUS" = "COMPLETED" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ! (${i}ì´ˆ)"
            break
          elif [ $i -eq 60 ]; then
            echo "âš ï¸  ë°°í¬ ê²€ì¦ íƒ€ì„ì•„ì›ƒ (60ì´ˆ)"
            break
          fi

          sleep 1
        done

    - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ GLI Django API Staging ë°°í¬ ì„±ê³µ!"
          echo "ğŸŒ URL: https://stg-api.glibiz.com"
          echo "ğŸ·ï¸  BUILD_UID: ${{ env.BUILD_UID }}"
          echo "ğŸ³ Image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
        else
          echo "âŒ GLI Django API Staging ë°°í¬ ì‹¤íŒ¨!"
        fi
